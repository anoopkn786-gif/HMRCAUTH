<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OAuth Redirect</title>
  <style>
    html,body {
      height:100%; margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:#f7f7f8; color:#111;
    }
    .wrap { height:100%; display:flex; align-items:center; justify-content:center; }
    .card {
      background:white; border-radius:10px; padding:24px;
      box-shadow:0 6px 20px rgba(0,0,0,0.08);
      max-width:720px; width:90%; text-align:center;
    }
    h1 { margin:0 0 12px; font-size:18px; font-weight:600; }
    pre {
      white-space:pre-wrap; word-break:break-word;
      background:#f3f4f6; padding:12px; border-radius:6px;
      margin:12px 0; font-size:14px;
    }
    .muted { color:#666; font-size:13px; margin-top:8px; }
    button {
      margin-top:12px; padding:8px 14px;
      border:none; border-radius:6px;
      background:#2563eb; color:white;
      font-size:14px; cursor:pointer; transition:background 0.2s;
    }
    button:hover { background:#1d4ed8; }
    #copiedMsg {
      margin-top:8px; color:green; font-size:13px; display:none;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="main" aria-live="polite">
      <h1>Authorization Code</h1>
      <pre id="auth-code">Waiting for code...</pre>
      <button id="copyBtn" style="display:none;">Copy Code</button>
      <div id="copiedMsg">âœ… Code copied to clipboard!</div>
      <div id="state" class="muted" style="display:none"></div>
    </div>
  </div>

  <script>
    (function () {
      // Parse params from URL
      const params = new URLSearchParams(
        window.location.search || window.location.hash.slice(1)
      );
      const code = params.get('code');
      const state = params.get('state');

      const codeEl = document.getElementById('auth-code');
      const stateEl = document.getElementById('state');
      const copyBtn = document.getElementById('copyBtn');
      const copiedMsg = document.getElementById('copiedMsg');

      if (code) {
        codeEl.textContent = code;
        copyBtn.style.display = 'inline-block';
        if (state) {
          stateEl.style.display = 'block';
          stateEl.textContent = 'State: ' + state;
        }

        console.log('Auth code:', code);
        console.log('Window opener:', window.opener);

        try {
      if (window.opener && !window.opener.closed) {
        window.opener.postMessage(
          { type: "oauthResponse", code, state },
          "*" // you can replace "*" with your origin for better security
        );
        console.log("Message sent to parent window.");
      }
    } catch (err) {
      console.error("Error posting message to opener:", err);
    }

        // Broadcast the code so parent can receive it
        const channel = new BroadcastChannel('HMRCAUTHTOKEN');
        channel.postMessage(code);

        // Enable copy button
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(code);
            copiedMsg.style.display = 'block';
            setTimeout(() => (copiedMsg.style.display = 'none'), 2000);
          } catch (err) {
            alert('Failed to copy code. Please copy manually.');
          }
        });
      } else {
        codeEl.textContent = 'No code found in URL.';
      }
    })(); // <-- this closes the IIFE properly
  </script>
</body>
</html>

